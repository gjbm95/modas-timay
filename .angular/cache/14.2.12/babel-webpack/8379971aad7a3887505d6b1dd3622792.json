{"ast":null,"code":"import { ArrayIteratorPrototype, ArrayIteratorPrototypeNext, ArrayPrototypeSymbolIterator, GeneratorPrototypeNext, IteratorPrototype, NativeArrayPrototypeSymbolIterator, NativeWeakMap, ObjectCreate, ObjectDefineProperty, ReflectGetOwnPropertyDescriptor, ReflectOwnKeys, SymbolIterator, WeakMapPrototypeGet, WeakMapPrototypeSet } from \"./primordials.mjs\";\n/** @type {WeakMap<{}, IterableIterator<any>>} */\n\nconst arrayIterators = new NativeWeakMap();\nconst SafeIteratorPrototype = ObjectCreate(null, {\n  next: {\n    value: function next() {\n      const arrayIterator = WeakMapPrototypeGet(arrayIterators, this);\n      return ArrayIteratorPrototypeNext(arrayIterator);\n    }\n  },\n  [SymbolIterator]: {\n    value: function values() {\n      return this;\n    }\n  }\n});\n/**\n * Wrap the Array around the SafeIterator If Array.prototype [@@iterator] has been modified\n *\n * @type {<T>(array: T[]) => Iterable<T>}\n */\n\nexport function safeIfNeeded(array) {\n  if (array[SymbolIterator] === NativeArrayPrototypeSymbolIterator && ArrayIteratorPrototype.next === ArrayIteratorPrototypeNext) {\n    return array;\n  }\n\n  const safe = ObjectCreate(SafeIteratorPrototype);\n  WeakMapPrototypeSet(arrayIterators, safe, ArrayPrototypeSymbolIterator(array));\n  return safe;\n}\n/** @type {WeakMap<{}, Generator<any>>} */\n\nconst generators = new NativeWeakMap();\n/** @see https://tc39.es/ecma262/#sec-%arrayiteratorprototype%-object */\n\nconst DummyArrayIteratorPrototype = ObjectCreate(IteratorPrototype, {\n  next: {\n    value: function next() {\n      const generator = WeakMapPrototypeGet(generators, this);\n      return GeneratorPrototypeNext(generator);\n    },\n    writable: true,\n    configurable: true\n  }\n});\n\nfor (const key of ReflectOwnKeys(ArrayIteratorPrototype)) {\n  // next method has already defined\n  if (key === \"next\") {\n    continue;\n  } // Copy ArrayIteratorPrototype descriptors to DummyArrayIteratorPrototype\n\n\n  ObjectDefineProperty(DummyArrayIteratorPrototype, key, ReflectGetOwnPropertyDescriptor(ArrayIteratorPrototype, key));\n}\n/**\n * Wrap the Generator around the dummy ArrayIterator\n *\n * @type {<T>(generator: Generator<T>) => IterableIterator<T>}\n */\n\n\nexport function wrap(generator) {\n  const dummy = ObjectCreate(DummyArrayIteratorPrototype);\n  WeakMapPrototypeSet(generators, dummy, generator);\n  return dummy;\n}","map":null,"metadata":{},"sourceType":"module"}